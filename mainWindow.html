<!DOCTYPE html>
<html lang="en">

<head>

  <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src
       see above for hashing specific scripts
       TODO - for now using unsafe-inline -- eventually may want to secure this
       with specifics
       TODO - may want to inject these into session instead per Electron guide
  -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src
      'self'
      'unsafe-inline'
      https://jquery.com/
      https://code.jquery.com/
      https://cdnjs.cloudflare.com/
      https://fonts.googleapis.com/
      https://fonts.gstatic.com/
      https://d3js.org ">
  </meta>

  <title>Viffy</title>

  <!-- https://stackoverflow.com/questions/32621988/electron-jquery-is-not-defined -->
  <!-- Insert this line above script imports  -->
  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

  <script
	  src="https://code.jquery.com/jquery-3.3.1.min.js"
	  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
	  crossorigin="anonymous">
  </script>

  <!-- Materialize -->
  <!-- Materialize CDNs -->
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- End Materialize -->

  <!-- Plotting / Charting / Data Visualization
       v3 to keep the refs to d3.scale.linear()
       v5 will start using eg d3.scaleLinear
       Previously using v3        d3.v4.min.js                  -->
  <!--<script src="https://d3js.org/d3.v4.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>

  <link rel="stylesheet" href="css/custom.css">

  <!-- Paired with pre-script line - to allow same code for electron app and
       browser-based implementations in theory -->
  <!-- Insert this line after script imports -->
  <script>if (window.module) module = window.module;</script>

</head>



<body>
  <header></header>



  <!--
  ******************************************************************************
          MAIN
  ******************************************************************************
  -->

  <main>

    <nav>
      <div class="nav-wrapper sm">
        <a href="" class="brand-logo center sm">Viffy</a>
      </div>
    </nav>

    <ul></ul>


    <ul id="serialPortSelectionAccordion" class="collapsible collapsible-accordion">
      <li class="active">
        <a class="collapsible-header">Serial Port Selection
          <i class="material-icons sidenav-dd-expand">arrow_drop_down</i>
        </a>
        <div class="collapsible-body">

          <h5>Virtual Serial Port (VCP) Devices</h5>
          <div id="vcp_error"></div>
          <div id="vcp_ports"></div>

          <h5>FTDI-Driver (D2XX, etc.) Devices</h5>
          <div id="ftdi_error"></div>
          <div id="ftdi_ports"></div>

          <hr />

          <ul class="collapsible collapsible-accordion">
            <li>
              <a class="collapsible-header">Notes about the port discovery and implementation<i class="material-icons sidenav-dd-expand">arrow_drop_down</i></a>
              <div class="collapsible-body">
                <div id="ports-info">
                  <p>Note: These are serial ports returned by serialport which means that
                    your device would be listed here if is intended to enumerate as a serial
                    port, real or virtual.  For example, using the FTDI VCP driver.
                  </p>
                  <p>
                    However, if your device is intended to be accessed as an FTDO D2XX driver
                    device target, then you should/will not see it in this listing until
                    the d2xx device listing is added to this code.  You can still click SELECTME
                    at any serial device here and you'll then see the buttons to test access to the
                    first detected d2xx FTDI device.
                  </p>
                  <p>
                    The FTDI (D2XX) devices are listed in the console.log output, so you can
                    see which device is at index 0 (and thus the device to be opened).
                  </p>
                </div>
              </div>
            </li>
          </ul>

          <div id="ports_go_button"></div>

        </div>
      </li>
    </ul>




    <!-- TODO place into card or section, etc.-->
    <div id="active_ports_ui_indicators">
      <button id="btnDataPortStatus" class="btn-large blue hide" onclick="btnDataPortClick(this)">Data Port</button>
      <button id="btnControlPortStatus" class="btn-large blue hide" onclick="btnControlPortClick(this)">Control Port</button>
    </div>



    <!-- .......................................... --><!--
    ***********************************************
      CARD - Serial Port Buttons / Controls (Init no display)
    *********************************************** -->
    <!-- Could add 2 levels of grid containment to this card section -->
    <div id="activeSerialPortStuff" class="card teal lighten-4" style="display:none;">
      <div class="card-content">
        <span class="card-title">Selected Serial Port:&nbsp;
          <span id="activePort"></span>
        </span>
        <br>
        <div class="container-buttons">
          Available controls:
          <div class="card-action">
            <p>Standard Buttons</p>
            <span id="serialOpenBtnSpan">
              <button name="serialOpenBtn" id="serialOpenBtn" onclick="serialOpen()">Open</button></span>
            <span id="serialCloseBtnSpan">
              <button name="serialCloseBtn" id="serialCloseBtn" onclick="serialClose()">Close</button></span>
            <span id="serialTestWriteSpan">
              <button name="serialTestWrite" id="serialTestWrite" onclick="serialTestWrite()">Test Write</button></span>
          </div>
          <div class="card-action">
            <p>Custom Buttons Loaded From File:</p>
            <div id="serialButtonsFromFileDiv"></div>
          </div>
        </div>
      </div>
    </div>







    <!-- .......................................... --><!--
    ***********************************************
      CARD - Control Port Buttons / Controls (Init no display)
    *********************************************** -->
    <!-- Could add 2 levels of grid containment to this card section -->
    <div id="activeControlPort" class="card teal lighten-4" style="display:none;">
      <div class="card-content">
        <span class="card-title">Control Port:&nbsp;
          <span id="activeControlPortName"></span>
        </span>
        <br>
        <div class="container-buttons">
          <div class="card-action">
            <p>Standard Buttons</p>
            <span id="controlPortOpenBtnSpan">
              <button name="controlPortOpenBtn" id="controlPortOpenBtn" onclick="controlPortOpen()">Open</button></span>
            <span id="controlPortCloseBtnSpan">
              <button name="controlPortCloseBtn" id="controlPortCloseBtn" onclick="controlPortClose()">Close</button></span>
            <span id="controlTestWriteSpan">
              <button name="controlPortTestWrite" id="controlPortTestWrite" onclick="controlTestWrite()">Test Write</button></span>
          </div>
          <div class="card-action">
            <span id="stuffToSendSpan">
              <div class="input-field">
                <i class="material-icons prefix">account_circle</i>
                <input type="text" id="stuffToSend" placeholder="Put (or Type) some stuff here to send" class="validate">
                <label for="stuffToSend">Stuff to Send</label>
                <span class="helper-text" data-error="wrong" data-success="right">Helper text, yeah, just type some stuff up there to send</span>
              </div></span>
            <span id="sendButtonSpan">
              <button id="sendButton" onclick="controlPortSendStuff()">Send</button></span>
          </div>
          <div class="card-action">
            <p>Custom Control Buttons Loaded From File:</p>
            <div id="controlPortButtonsFromFileDiv"></div>
          </div>
        </div>
      </div>
    </div>







    <!-- .......................................... --><!--
    ***********************************************
      CARD - Chart
    *********************************************** -->
    <div class="row">
      <div class="col s12"><!-- was col s12 m7 -->
        <div class="card blue-grey darken-1">
          <div class="card-content white-text">
            <span class="card-title">
              <span class="chart-title">Waveform Display</span>
            </span>
            <div id="chart"></div>
            <div class="card-action">
              <a href="#">Double-click chart background to reset zoom</a>
            </div>
          </div>
        </div>
      </div>
    </div>




    <!-- .......................................... --><!--
    ***********************************************
      CARD - Output console-like
    *********************************************** -->
    <div class="row"><div class="col s12">
        <div class="card blue-grey darken-1">
          <div class="card-content white-text">
            <span class="card-title">
              <span class="output-title">Output</span>
            </span>
            <div id="output">
              <pre class="preserve-whitespace pre-scrollable">
                <span id="output">Output log</span>
              </pre>
            </div>
            <div class="card-action">
              <a href="#">Link</a>
            </div>
          </div>
        </div>
    </div></div>

  </main><!-- main -->








  <!--
  ******************************************************************************
          NAVIGATION
  ******************************************************************************
  -->

  <!--https://materializecss.com/sidenav.html -->
  <ul id="slide-out" class="sidenav sidenav-fixed">
      <li><a href="#!">First Sidebar Link</a></li>
      <li><a href="#!">Second Sidebar Link</a></li>
      <li class="no-padding">
        <ul class="collapsible collapsible-accordion">
          <li>
            <a class="collapsible-header">Dropdown<i class="material-icons sidenav-dd-expand">arrow_drop_down</i></a>
            <div class="collapsible-body">
              <ul>
                <li><a href="#!" class="waves-effect waves-teal btn-flat">First</a></li>
                <li><a href="#!">Second</a></li>
                <li><a href="#!">Third</a></li>
                <li><a href="#!">Fourth</a></li>
              </ul>
            </div>
          </li>
        </ul>
      </li>
    </ul>
    <!--<ul class="right hide-on-med-and-down">
      <li><a href="#!">First Sidebar Link</a></li>
      <li><a href="#!">Second Sidebar Link</a></li>
      <li><a class="dropdown-trigger" href="#!" data-target="dropdown1">Dropdown<i class="material-icons right">arrow_drop_down</i></a></li>
      <ul id='dropdown1' class='dropdown-content'>
        <li><a href="#!">First</a></li>
        <li><a href="#!">Second</a></li>
        <li><a href="#!">Third</a></li>
        <li><a href="#!">Fourth</a></li>
      </ul>
    </ul>-->
    <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>















  <!--
  ******************************************************************************
          SCRIPT
  ******************************************************************************
  -->


  <script type="text/javascript">

    // Dev Notes to Self
    // Note that document.getElementById("myBtn").addEventListener('click', myFcn)
    // will work when Content-Security-Policy (CSP) does not allow
    // inline event handlers, like if CSP: script-src https://example.com/
    // See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src




    const electron = require('electron');
    const {ipcRenderer} = electron;
    const ul = document.querySelector('ul');


    // https://stackoverflow.com/questions/36980201/how-to-reset-nodejs-stream

    // Create stream object for access by both sprenderer and charting
    //const dataBuf = Buffer.alloc(100*4096, 0);
    //const streamBuffers = require('stream-buffers');
    const rsb = require('./readable_streambuffer.js');
    const stream = require('stream');
    // On platform for testing: using standard node stream buffers:
    // At freq of 10 (ms)
    // - chunkSize of 2 * 4095 gives steady sync graph, with eventual huge buffer (overrun)
    // - chunkSize of 3 * 4095 gives walking graph and glitches due to emptiness (underrun)
    var chartBuf = null;
    var ourReadableStreamBuffer = null;
    var resetReadableStream = function() {
      chartBuf =  Buffer.alloc(4095, 127);
      // changing below to 20ms (and doubling the chunksize) doesn't stop the
      // crash malloc errors
      ourReadableStreamBuffer = new rsb.ReadableStreamBuffer({
        frequency: 10,       // in milliseconds // 5 or 7 was ok // 10 less crashy // less than 7ms to be faster than incoming packets of 4096
        chunkSize: (3*4095), //16380, //(4095)//,     // bytes -- 4096 gives a left-ward walk -- 4095 was generally steady
        initialSize: (100 * 1024),    // was 1000 // added these two for size management due to constant overflow
        //incrementAmount: (10 * 1024)  // zero does nothing - doesn't cap it
      });
      ourReadableStreamBuffer.on('readable', function(data) {

        try {
          var chunk;
          //console.log(ourReadableStreamBuffer.size());
          if ( ourReadableStreamBuffer.size() > (1000*1024) ) {
            console.log(ourReadableStreamBuffer.size());
            //console.log("ALERT: ourReadableStreamBuffer is larger than ...1MB ... dumping data ...");
            // Do something to dump or pause this
            //ourReadableStreamBuffer.pause(); // no effect in a readable event listener
            //console.log("new ourReadableStreamBuffer size: " + ourReadableStreamBuffer.size());
          }
          // Could try to:
          // - Increment the decimation counter here instead and it talks to the sprendered code
          // or
          // - Use 'data' event subscription instead and then use pause and resume to allow
          //   screen plotting to catch up
          while((chunk = ourReadableStreamBuffer.read()) !== null) {
            //assert.isTrue(chunk instanceof Buffer);
            //console.log(chunk.length);
            //console.log('t');
            // could implement skipping code here - take every 8th and plot it
            //n = (n > 8) ? 0 : n;
            //if ( n === 8 ) {

            // deimation stuff: no dice - not a copy must not be the bottleneck
            //dataPushDecimationCounter++; // increment only with each chunk
            //if ( dataPushDecimationCounter > decimationValue ) {
            //  dataPushDecimationCounter = 0;
            //}
            //if ( dataPushDecimationCounter === decimationValue ) {
            // TODO - add try catches for all memory stuff to catch serial port
            // (data port) errors that might be creating the malloc errors in these
            // revisions
            chunk.copy(chartBuf, 0, 0, 4095);

            // Debugging:
            console.log(chartBuf.slice(0,11)); // checking the SOF section
            // The 5th bit [4] is the sequence_id - it begins at 1 and wraps after 255
            // Thus we are only counting 255 WFs maximum (not 256)
            // Though, need to check that after the RST signal - as this is for
            // just after power up as for the first WF returning 1 for seq_id


            //}
            //}
            //n++;
            // nope the n thing still allows the internal buffer to grow ... and slow
            //console.log(n);
          }
        } catch (e) {
          console.log("Error in readable event: " + e);
        }
      });
    }





    // From SP EG
    // You can also require other files to run in this process
    const sprend = require('./sprenderer.js')
    //const chartRend = require('./chartRend.js')
    //const chart = require('./simpleChartRend.js')
    const chart = require('./bigWfDataChart.js');

    // Add item
    ipcRenderer.on('item:add', function(e, item){
      ul.className = 'collection';
      const li = document.createElement('li');
      li.className = 'collection-item';
      const itemText = document.createTextNode(item);
      li.appendChild(itemText);
      ul.appendChild(li);
    });

    // Clear items
    ipcRenderer.on('item:clear', function(){
      ul.innerHTML = '';
      ul.className = '';
    });


    // TODO - need to use some kind of buffer management here
    // sprenderer (FTDI/D2XX) Port data received from peripheral device
    // TODO - we're not really using ipc here -- fix this -- clean up / remove
    ipcRenderer.on('port:ondata', function(e, data){
      chart.update(data);
    });

    var animStarted = false;
    function mainWindowUpdateChartData(data) {
      //chart.update(data);
      //return;

      if ( data !== null ) {
        console.log("ERROR: mainWindowUpdateChartData is not implemented \
          in this configuration for regular calls.  Currently, chart is expected to use    \
          requestAnimationFrame and thus just the first call initiates the looped calls.");
      }

      if ( !animStarted ) {
        resetReadableStream();   // Or move to data Port event handler for close()?
        console.log("mainWindowUpdateChartData: animStarted = false, calling renderChart()");
        chart.renderChart(); // This initiates the loop
        animStarted = true;
      } else {
        // clearReadStream??? or just reset it too?
        console.log("mainWindowUpdateChartData: animStarted = true, calling cancelRenderChart()");
        chart.cancelRenderChart();
        animStarted = false;
      }
    }

    // Remove item on double-click from main  list
    ul.addEventListener('dblclick', removeItem);

    function removeItem(e){
      e.target.remove();
      if(ul.children.length == 0){
        ul.className = '';
      }
    }

    // Serial port -- TODO MOVE & DRY
    function serialSelect(button) {
      var d = document.querySelector("#activePort");
      $('#activeSerialPortStuff').show();
      d.innerHTML = button.name;
    }
    function serialCheckbox(checkbox) {
      //alert(checkbox.checked); // yeah the property works, even with the materializecss
      sprend.serialCheckbox(checkbox);
    }
    function serialOpen() {
      var d = document.querySelector("#activePort");
      var spname = d.innerHTML;
      sprend.serialOpenByName(spname);
    }
    function serialClose() {
      sprend.serialClose();
    }
    function controlPortClose() {
      sprend.controlPortClose();
    }
    function serialTestWrite() {
      sprend.serialTestWrite();
    }
    function serialSendData(commandAndType, returnDataTo) {
      sprend.serialSendData(commandAndType, returnDataTo);
    }
    function controlPortSendData(commandAndType, returnDataTo) {
      sprend.controlPortSendData(commandAndType, returnDataTo);
    }
    function beginSerialComms() {
      sprend.beginSerialComms();
    }
    function btnDataPortClick(button) {
      sprend.btnDataPortClick(button);
    }
    function btnControlPortClick(button) {
      sprend.btnControlPortClick(button);
    }
    function controlPortSendStuff() {
      sprend.controlPortSendStuff($('#stuffToSend'));
    }
    function controlPortSendDataFromTextInput(button, commandAndType) {
      sprend.controlPortSendDataFromTextInput(button, commandAndType);
    }
    // TODO wrap pass-through functions above and thus DRY ...

    // Materialize - sidenav support
    // Without jQuery
    /*document.addEventListener('DOMContentLoaded', function() {
      var options = {};
      var elems = document.querySelectorAll('.sidenav');
      var instances = M.Sidenav.init(elems, options);
    });*/

    // Initialize collapsible (uncomment the lines below if you use the dropdown variation)
    // var collapsibleElem = document.querySelector('.collapsible');
    // var collapsibleInstance = M.Collapsible.init(collapsibleElem, options);

    // Or with jQuery:
    // Materialize inits
    // For both browser and electron app work, this needs the script pre and
    // post load items in the head section to prevent undefined $ or jQuery etc
    //jQuery(document).ready(function($){
    $(document).ready(function(){
    //window.onload = function(){

      $('.sidenav').sidenav();
      $(".dropdown-trigger").dropdown();
      $('.collapsible').collapsible({
        accordion: true
      });
      loadButtons();
    //}
      // Just for testing the chart update function
      setTimeout(function() {
        var newdat = [0,.01, .02, .03, .04, .05, .06, .07, .08, .09];
        chart.update(newdat);
      }, 300);

      // Check for stuff that needs to execute on page load after population
      serialCheckbox(); // arg not used ... TODO better way to do this of course

      // TEMP DEV TWEAKS for EXPOSURE etc
      // Temp : testing :
      //$("#activeControlPort").show();

    }); // $(document).ready()

    function loadButtons() {

      // TODO use meta list for button files to be loaded and for various port-style devices

      // Basic test functions and single-port style device buttons (aka DLITE legacy)
      // Can use user data path instead when running live not dev
      const path = "./user-data/buttons-example.json"
      var buttons = require(path).buttons;
      console.log(buttons.length + " buttons found.");
      buttons.forEach( function (b) {
        var newb = $('<button/>')
          .text(b.title)
          .prop('title', b.description)
          .click(function () {
            //alert(b.command.type + ': ' + b.command.value)
            serialSendData(b.command, b.returnDataTo);
          });
        $('#serialButtonsFromFileDiv').append(newb);
      });


      // Dual-port style functions
      //
      // Control port
      const cp_path = "./user-data/control-port-buttons.json"
      var buttons = require(cp_path).buttons;
      var textInputs = require(cp_path).textInputs;
      console.log(buttons.length + " control port buttons found.");
      buttons.forEach( function (b) {
        var newb = $('<button/>')
          .text(b.title)
          .prop('title', b.description)
          .click(function () {
            controlPortSendData(b.command, b.returnDataTo);
          });
        $('#controlPortButtonsFromFileDiv').append(newb);
      });

      textInputs.forEach( function (ti) {
        var div = $('<div>')
          .prop('id', "div" + ti.label.replace(/\s/g,''))
          .addClass("row");
        var smallDiv = $('<div>')
          .addClass("col s6 right-align");
        var smallDiv2 = $('<div>')
          .addClass("col s6");
        var span = $("<span>").text(ti.label);
        var input = $("<input type='text'>")
          .addClass("input-field")
          .prop('title', ti.description)
          .prop('id', "input" + ti.label.replace(/\s/g,''));
        var button = $("<button>")
          .text(ti.label)
          .addClass("btn waves-effect waves-light")
          .prop('id', "button" + ti.label.replace(/\s/g, ''))
          .click(function () {
            controlPortSendDataFromTextInput(this, ti.command);
          });
        var label = $("<label>")
          .attr("for", ti.label.replace(/\s/g,''));
        $(label).append(input).append(span);
        var c1 = $(smallDiv).append(button);
        var c2 = $(smallDiv2).append(label);
        $(div).append(c1).append(c2);
        $('#controlPortButtonsFromFileDiv').append(div);
      });

    }




  </script>

</body>
</html>
